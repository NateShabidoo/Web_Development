
<?php
//Import PHPMailer classes into the global namespace
//These must be at the top of your script, not inside a function
/*use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;*/

require 'database/config.php';
require 'PHPMailer/Exception.php';
require 'PHPMailer/PHPMailer.php';
require 'PHPMailer/SMTP.php';

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;

if(isset($_POST["email"])) {

	$emailTo = $_POST["email"];

    $code = uniqid(true);

    $query = "INSERT INTO resetPasswords (email_reset, code) VALUES ('$emailTo', '$code')";
    $query_run = mysqli_query($conn, $query);

    	if(!$query_run) {
		exit("Error1");
	    }

//Create an instance; passing `true` enables exceptions
$mail = new PHPMailer(true);

try {
    //Server settings
    $mail->isSMTP();                                   //Send using SMTP
    $mail->Host       = 'mail.simplechartsri.com';//
    $mail->SMTPAuth   = true;                     //Enable SMTP authentication
    $mail->Username   = 'admin@simplechartsri.com'; //  SMTP username 
    $mail->Password   = 'D@t@V1z!';   //SMTP password
    $mail->SMTPSecure = 'ssl';   //PHPMailer::ENCRYPTION_SMTPS;            //Enable implicit TLS encryption
    $mail->Port       = 465;

    //Recipients
    $mail->setFrom('admin@simplechartsri.com', 'simplechartsri.com');
    $mail->addAddress($emailTo);     //Add a recipient
    $mail->addReplyTo('no-reply@simplecharts.com', 'No Reply');

    //Content
    $url = "http://" . $_SERVER["HTTP_HOST"] . dirname($_SERVER["PHP_SELF"]) . "resetlink.php?code=$code";
    $mail->isHTML(true);                   //Set email format to HTML
    $mail->Subject = 'Your Password Reset Link';
    $mail->Body    = "<h2>You Requested a Password Reset</h2> Click <a href='$url'>this Link</a> to Reset";
    $mail->AltBody = 'This is the body in plain text for non-HTML mail clients';

    $mail->send();
    echo 'Password Reset Link has been sent, it may take up to 5 minutes, you may need to check spam folder';
} catch (Exception $e) {
    echo "Message could not be sent. Mailer Error: {$mail->ErrorInfo}";
}
exit();
}
?>


<!DOCTYPE html>
<html>
<head>

<title>Reset Password</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous"/>
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,700">
        <link href="test.css?v=<?php echo time(); ?>" rel="stylesheet">
        <link href="style/ui.css?v=<?php echo time(); ?>" rel="stylesheet">

        <style>
            body { 
                font-family: "Poppins", serif;
                background-color: white;
            }
        </style>
    </head>

        
<body>

        <div class="logo">
            <a href="index_ui.php" style="display: flex; align-items: center">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
                    <path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z"/>
                </svg>
                <div class="logo-text">SimpleChartsRI</div>
            </a>
        </div>
        
    <div id="">
		<center>
	        <div class="H1">Forget password</div>
	        <br>
	    	<div class="P">Weâ€™ll send you instructions to reset your password.</div>
	    </center>
	
	<form class="" action="" method="POST">
		<div class="P">Email</div>
	    <input type="text" name="email" class="inputvalues" placeholder="Type your email" pattern="(?=.*[@]).{8,}" title="Email address must contain an '@' symbol" required>
	    <br>
	    <input type="submit" name="submit" class="homeBtn-signup" value="Reset Password">
	<div style="height: 45px; display: flex; justify-content: center; flex-direction: column; text-align: center;">
		    <a href="login_ui.php">Return to log in</a>
	</div>
	    
	    
	</form>
	

		
	</div>
<!--
<form method="POST">
<input type="text" name="email" placeholder="email" pattern="(?=.*[@]).{8,}" title="Email address must contain an '@' symbol" required>
<br>
<input type="submit" name="submit" value="Reset email">
</form>
-->

</body>
</html>
